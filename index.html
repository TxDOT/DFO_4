<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>DFO Tool</title>
    <!-- ArcGIS JS 4 CSS -->
    <link rel="stylesheet" href="https://js.arcgis.com/4.11/esri/css/main.css">
    <link rel="stylesheet" href="https://js.arcgis.com/4.11/dijit/themes/claro/claro.css">
    <!-- Bootstrap CSS CDN  -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <!-- FontAwesome CSS CDN  -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css" integrity="sha384-5sAR7xN1Nv6T6+dT2mhtzEpVJvfS3NScPQTrOxhwjIuvcA67KV2R5Jz6kr4abQsz"crossorigin="anonymous">

    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            font-family: 'Poppins', sans-serif !important;
        }

        #mapViewDiv {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
        }
        #divReadout {
            position: absolute;
            /* left: 60px; */
            /* width: 300px */
            top: 20px;
            z-index: 100;
            /* color: white; */
            /* text-shadow: -2px -2px 0 #FFF, 2px -2px 0 #FFF, -2px 2px 0 #FFF, 2px 2px 0 #FFF; */
        }
        #outputMessages {
            position: absolute;
            z-index: 70;
            top: 0px;
            left: 0;
            bottom: 0;
            box-sizing: border-box;
            padding: 20px;
            height: 25%;
            width: 220px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 14px;
            line-height: 30px;
            overflow: auto;
     }
    </style>
</head>
<body>
    <div id="outputMessages">
        <div id="divReadout">
        <button type="button" class="btn btn-dark btn-block" id="btnMeasureReadout" data-return="0" title="Click to Activate/Deactive LRS Tool.">LRS Tool</button>
            <br><br>
            <input id="radMPT" type="radio" name="lrsType" value="MPT" checked> Control Section Milepoint<br>
            <input id="radDFO" type="radio" name="lrsType" value="DFO"> Distance From Origin<br>
        </div>
    </div>
    <div id="mapViewDiv">

    </div>


    <!-- jQuery CDN - Slim version (=without AJAX) -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous">
    </script>
    <!-- Popper.JS CDN-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous">
    </script>
    <!-- Bootstrap JS -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous">
    </script>

    <!-- Enable WebGL Rendering-->
    <script>
        var dojoConfig = {
            has: {"esri-featurelayer-webgl": 1}
        };
    </script>
    <!-- ArcGIS JS 4 -->
    <script src="https://js.arcgis.com/4.11"></script>

    <script>

        var TxDOTVectorTileLayer;
        var esri;
        var map;
        var queryTask;
        var query;
        // var measureClicked = false;
        var gidWithMeasuresGeom;
        var mapPoint;
        var featurePartIndex;

        require([

        // map, view, and layers
        "esri/Map",
        "esri/views/MapView",
        "esri/layers/VectorTileLayer",
        "esri/Basemap",

        // UI
        "esri/widgets/Home",
        "esri/widgets/Zoom",
        "esri/widgets/ScaleBar",

        // esri config and tasks
        "esri/config",
        "esri/tasks/support/Query",
        "esri/tasks/QueryTask",

        // geometry
        "esri/geometry/Extent",
        "esri/geometry/geometryEngine",
        "esri/geometry/SpatialReference",
        "esri/geometry/Point",
        "esri/geometry/Polyline",

        // draw
        "esri/views/draw/Draw",
        "esri/Graphic",

        // dojo
        "dojo/dom",
        "dojo/on",
        "dojo/parser",
        "dojo/domReady!"
        ],

        function(
        Map,
        MapView,
        VectorTileLayer,
        Basemap,
        Home,
        Zoom,
        ScaleBar,
        esriConfig,
        Query,
        QueryTask,
        Extent,
        geometryEngine,
        SpatialReference,
        Point,
        Polyline,
        Draw,
        Graphic,
        dom,
        on,
        parser
        ) {
            // CONSTRUCT MAP WITH INITIAL BASEMAP
            const spmVectorTile = new VectorTileLayer({
                url: "https://tiles.arcgis.com/tiles/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Vector_Tile_Basemap/VectorTileServer",
                id: "txdot"
            });

            const spmBasemap = new Basemap({
                baseLayers: spmVectorTile,
            });

            const map = new Map({
                basemap: spmBasemap
            });

            // VIEW
            const mapView = new MapView({
                container: "mapViewDiv",
                map: map,
                center: [-100.341389, 31.132222],
                zoom: 6,
                spatialReference: {wkid: 102100},
                constraints: {
                    minZoom: 5,
                    rotationEnabled: false
                },
                popup: {
                    dockOptions: {
                        position: "bottom-right"
                    }
                }
            });

            // ESRI UI WIDGETS
            const home = new Home({
                view: mapView
            });
            const zoom = new Zoom({
                view: mapView
            });
            const scalebar = new ScaleBar({
                view: mapView,
                unit: "dual",
            });

            // ADD/MODIFY WIDGETS IN THE VIEW
            mapView.ui.remove("attribution");
            mapView.ui.empty("top-left");
            mapView.ui.add([
                {
                    component: home,
                    position: "top-right",
                    index: 1
                }, {
                    component: zoom,
                    position: "top-right",
                    index: 0
                }, {
                    component: scalebar,
                    position: "bottom-right",
                    index: 0
                }
            ]);

            // EVENTS
            $(document).ready(function(){

                // TOGGLE LRS TOOL
                $('#btnMeasureReadout').click(function() {
                    let cursor = $('#mapViewDiv');
                    let lrsTool = $(this).data('return');
                    if(lrsTool) {
                        cursor.css({'cursor':'auto'});
                        $(this).attr('class','btn btn-dark btn-block');
                        mapView.graphics.removeAll();
                        $(this).data('return',0);
                    }
                    else {
                        cursor.css({'cursor':'crosshair'});
                        $(this).attr('class','btn btn-danger btn-block');
                        $(this).data('return',1);
                    }
                });

                // LISTEN FOR MAPVIEW CLICK EVENT
                mapView.on("click", identRouteForM);


                // MAIN FUNCTIONS
                function identRouteForM(event) {
                    let lrsTool = $('#btnMeasureReadout').data('return');
                    if (lrsTool) {
                        let query, queryTask, mapPoint, point, pxWidth, padding, newGeom;
                        let controlSectionUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Control_Sections/FeatureServer/0";
                        let roadwaysUrl = "https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Roadways/FeatureServer/0";
                        if (document.getElementById("radMPT").checked) {
                            queryTask = new QueryTask({
                                url: controlSectionUrl
                            });
                        }
                        if (document.getElementById("radDFO").checked) {
                            queryTask = new QueryTask({
                                url: roadwaysUrl
                            });
                        }
                        query = new Query({
                            returnGeometry: true,
                            outFields: ["*"],
                            geometry: event.mapPoint,

                        });
                        // query.returnGeometry = true;
                        // query.outFields = ["*"];
                        // query.geometry = event.mapPoint;

                        mapPoint = event.mapPoint;

                        point = event.mapPoint;
                        pxWidth = mapView.extent.width / mapView.width;
                        padding = 15 * pxWidth;
                        newGeom = new Extent({
                            "xmin": point.x - padding,
                            "ymin": point.y - padding,
                            "xmax": point.x + padding,
                            "ymax": point.y + padding,
                            "spatialReference": point.spatialReference
                        });

                        query.geometry = newGeom;
                        console.log(query);
                        console.log(newGeom);
                        queryTask.execute(query).then(function(results){
                            console.log(results.features);
                        });
                        // queryTask.execute(query, getSegmentWithM);
                    }
                }

            // function identRouteForM(event) {
            //     if (measureClicked) {
            //     if (document.getElementById("radMPT").checked) {
            //       queryTask = new esri.tasks.QueryTask("https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Control_Sections/FeatureServer/0");
            //     }
            //     if (document.getElementById("radDFO").checked) {
            //       queryTask = new esri.tasks.QueryTask("https://services.arcgis.com/KTcxiTD9dsQw4r7Z/arcgis/rest/services/TxDOT_Roadways/FeatureServer/0");
            //     }
            //
            //     query = new esri.tasks.Query();
            //     query.returnGeometry = true;
            //     query.outFields = ["*"];
            //     query.geometry = event.mapPoint;
            //
            //     mapPoint = event.mapPoint;
            //
            //     var point = event.mapPoint;
            //     var pxWidth = map.extent.getWidth() / map.width;
            //     var padding = 15 * pxWidth;
            //     var newGeom = new esri.geometry.Extent({
            //       "xmin": point.x - padding,
            //       "ymin": point.y - padding,
            //       "xmax": point.x + padding,
            //       "ymax": point.y + padding,
            //       "spatialReference": point.spatialReference
            //     });
            //
            //     query.geometry = newGeom;
            //     // console.log(query);
            //     queryTask.execute(query, getSegmentWithM);
            //     }
            //   }
            });
        });
    </script>
</body>
</html>
